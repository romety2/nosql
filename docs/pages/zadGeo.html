<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
	<meta charset="utf-8">
	<meta http-equiv="Content-Type" content="text/html; charset=utf-8"/>
	<meta name="generator" content="pandoc"/>
  <title>Technologie NoSQL</title>
  <link rel="stylesheet" href="../style/style.css">
</head>
<body>
	<div class = "return">
		<a href="../index.html">powrót</a>
	</div>
	<div class = "description">
		<h1 class="text-center">Zadanie GEO</h1>
		</br>
		<h2>Informacje o danych</h2>	
		<p class="description-data">
			Dane zawierają najnowsze (luty 2017 r.) dane z katalogu pocztowego służb zdrowia w Wielkiej Brytanii.
			<a href="https://data.gov.uk/dataset/nhs-postcode-directory-latest-centroids" target="_blank">Źródło</a>.
			</br>
			Rozmiar: 2 GB
			</br>
			Ilość: 2593752
		</p>
		</br>	
		<h2>Instalacja i konfiguracja oprogramowania</h2>
		<h3>postgreSQL</h3>
		<p>
			Do rozwiązania zadania użyto bazy postgreSQL. Należy ją pobrać ze 
			<a href="https://www.enterprisedb.com/downloads/postgres-postgresql-downloads" target="_blank">strony</a>
			i zainstalować. Podczas instalacji możliwe, że będziemy musieli podać hasło do domyślnego użytkownika <i>postgres</i>.
		</p>
		<h3>jdk</h3>
		<p>
			Aby uruchomić bazę elasticsearch potrzebny jest najnowyszy jdk, który jest możliwy do sciągniećia ze
			<a href="http://www.oracle.com/technetwork/java/javase/downloads/index.html" target="_blank">strony</a> i zainstalować.
			</br></br>
			Upewnijmy się czy zmienne środowiskowe są odpowiednio skonfigurowane.
			</br>
			<div class="text-center">
				<i>Panel sterowania -> System -> Zmień ustawienia -> Zaawansowane (zakładka) -> Zmienne środowiskowe...</i>
			</div>
			</br>
			W <i>zmienne systemowe</i> szukamy zmiennej <i>JAVA_HOME</i> oraz sprawdzamy czy ścieżka
			jest ustawiona na zainstalowany przez z nas <i>jdk</i>.
			</br>
			Jeśli nie, zaznaczamy zmienną, klikamy <i>Edytuj...</i> oraz zmieniamy ścieżkę i ponownie uruchamiamy komputer.
		</p>
		<h3>jq</h3>
		<p>
			Narzędzie jq służy do przekształcenia danych w taki sposób, aby otrzymać tylko te dane które nas interesują.
			W naszym przypadku będą to dane które zawierają współrzędne geograficzne.
			</br>
			Aby zainstalować jq wstępnie trzeba zaisntalować framework Chocolatey.
			Uruchamiamy konsolę cmd <b>z uprawnieniami administratora</b> oraz wydajemy polecenie:
			<div class="command">
				<code>
@powershell -NoProfile -ExecutionPolicy Bypass -Command "iex ((New-Object System.Net.WebClient).DownloadString('https://chocolatey.org/install.ps1'))" && SET "PATH=%PATH%;%ALLUSERSPROFILE%\chocolatey\bin"
				</code>
			</div>
			Następnie, aby zaintalować jq należy wydać polecenie:
			<div class="command">
				<code>
chocolatey install jq
				</code>
			</div>
			Więcej na:
			<ul>
				<li><a href = "https://chocolatey.org/">chocolatey</a></li>
				<li><a href = "https://stedolan.github.io/jq/">jq</a></li>
			</ul>
		</p>
		</br>
		<h2>Elasticsearch</h2>
		<h3>Przekształcenie danych</h3>			
		<p>
			Ze <a href="https://data.gov.uk/dataset/nhs-postcode-directory-latest-centroids" target="_blank">strony</a>
			pobieramy plik z rozszeżeniem  <i>geojson</i>.
			</br>
			Usuwamy zbędne pola, zostawiamy dane <i>properties</i> oraz przenosimy do niego zaokrąglone dane geograficzne pod nazwa <i>location</i>
			, aby móc na nich odpowiednio operować. Zaokrąglenie współrzędnych jest konieczne, aby dane przeszły walidację z mappingiem podczas importu.
			</br>
			Plik z danymi, który pobrałem wymagał zmiany nazwy gdyż nie może zawierać znaków takich jak: _. Zamieniłem nazwę na <i>map.geojson</i>.
			</br>
			W moim przypadku interesujące pole to <i>features</i>, więc aby to zrobić w <i>cmd</i> wydajemy polecenie:
			<div class="command">
				<code>
jq ".features[] | (.geometry.coordinates) as $l | .properties |= .+ {location: $l} | .properties" map.geojson > mapPom.geojson 
				</code>
			</div>
			Następnie
			<div class="command">
				<code>
< mapPom.geojson jq --compact-output "{ \"index\": { \"_type\": \"test\" } }, ." > mapPom.bulk
				</code>
			</div>
			Podczas wykonywania tej operacji doszło do zużycia zasobów (ilustracja niżej). 
			</br></br>
			<div class="text-center">
				<img src="../images/screen1.PNG" height="400em" width="500em">
			</div>
			<div class="description-image">Procesor podczas przekształcania danych</div>
			</br></br>
			<div class="text-center">
				<img src="../images/screen2.PNG" height="400em" width="500em">
			</div>
			<div class="description-image">Pamięć podczas przekształcania danych</div>
			</br></br>
			<div class="text-center">
				<img src="../images/screen3.PNG" height="400em" width="500em">
			</div>
			<div class="description-image">Dysk podczas przekształcania danych</div>
			</br></br>
			Wykonanie trwało ok. 35 minut.
		</p>
		</br>
		<h3>Import danych</h3>
		<p>
			Pobieramy ze <a href="https://www.elastic.co/downloads/elasticsearch" target="_blank">strony</a> elasticsearch.
			</br>
			Następnie aby uruchomić serwer wykonujemy polecenie w konsoli <i>cmd</i>:
			<div class="command">
				<code>
[ścieżka gdzie pobrano elasticsearch]\elasticsearch-5.3.0\bin\elasticsearch.bat
				</code>
			</div>
			Pobieramy ze <a href="https://curl.haxx.se/download.html">strony</a> <i>curl'a</i> po czym kopijemy plik binarny do folderu w ktorym pracujemy,
			polecenie w konsoli <i>cmd</i>:
			<div class="command">
				<code>
copy [ścieżka gdzie pobrano curl]\curl\src\curl.exe [ścieżka wykonywany jest projekt]\curl.exe
				</code>
			</div>
			W nowej konsoli tworzymy bazę danych z mappingiem, który konieczny jest do wykonywania działań na współrzędnych (w moim przypadku o nazwie test), polecenie:
			<div class="command">
				<code>
curl -XPUT http://localhost:9200/test -d "{\"mappings\": {\"place\": {\"properties\": {\"objectid\": {\"type\": \"integer\"},\"pcd2\": {\"type\": \"string\"},\"pcds\": {\"type\": \"string\"},\"dointr\": {\"type\": \"string\"},\"oseast100m\": {\"type\": \"string\"},\"osnrth100m\": {\"type\": \"string\"},\"oscty\": {\"type\": \"string\"},\"odslaua\": {\"type\": \"string\"},\"oslaua\": {\"type\": \"string\"},\"osward\": {\"type\": \"string\"},\"usertype\": {\"type\": \"string\"},\"osgrdind\": {\"type\": \"string\"},\"ctry\": {\"type\": \"string\"},\"oshlthau\": {\"type\": \"string\"},\"gor\": {\"type\": \"string\"},\"oldha\": {\"type\": \"string\"},\"nhscr\": {\"type\": \"string\"},\"ccg\": {\"type\": \"string\"},\"psed\": {\"type\": \"string\"},\"cened\": {\"type\": \"string\"},\"edind\": {\"type\": \"string\"},\"ward98\": {\"type\": \"string\"},\"oa01\": {\"type\": \"string\"},\"nhsrg\": {\"type\": \"string\"},\"hro\": {\"type\": \"string\"},\"lsoa01\": {\"type\": \"string\"},\"ur01ind\": {\"type\": \"string\"},\"msoa01\": {\"type\": \"string\"},\"cannet\": {\"type\": \"string\"},\"scn\": {\"type\": \"string\"},\"oshaprev\": {\"type\": \"string\"},\"oldpct\": {\"type\": \"string\"},\"oldhro\": {\"type\": \"string\"},\"pcon\": {\"type\": \"string\"},\"canreg\": {\"type\": \"string\"},\"pct\": {\"type\": \"string\"},\"oseast1m\": {\"type\": \"string\"},\"osnrth1m\": {\"type\": \"string\"},\"oa11\": {\"type\": \"string\"},\"lsoa11\": {\"type\": \"string\"},\"msoa11\": {\"type\": \"string\"},\"location\": {\"type\": \"geo_point\" }}}}}"
				</code>
			</div>
			</br>
			Następnie dokonujemy importu poprzez polecenie: 
			<div class="command">
				<code>
curl -XPOST localhost:9200/test/_bulk --data-binary @mapPom.bulk		
				</code>
			</div>
			Import danych średnio zużywał zasoby komputera.
			</br></br>
			<div class="text-center">
				<img src="../images/screen10.PNG" height="400em" width="500em">
			</div>
			<div class="description-image">Procesor podczas importu danych do elasticsearch</div>
			</br></br>
			<div class="text-center">
				<img src="../images/screen11.PNG" height="400em" width="500em">
			</div>
			<div class="description-image">Pamięć podczas importu danych do elasticsearch</div>
			</br></br>
			<div class="text-center">
				<img src="../images/screen12.PNG" height="400em" width="500em">
			</div>
			<div class="description-image">Dysk podczas importu danych do elasticsearch</div>
			</br></br>
			Wykonanie trwało ok. 5 minut.
			</br>
			</br>
			Sprawdzamy czy wszystkie dane zostały zaimportowane, polecenie:
			<div class="command">
				<code>
curl -XGET localhost:9200/test/_count
				</code>
			</div>
			Po czym pojawiła się informacja:
			<div class="code">
				<pre>
					<code>
{"count":2593752,"_shards":{"total":5,"successful":5,"failed":0}}
					</code>
				</pre>
			</div>
		</p>
		<h3>Przykładowe pole</h3>
		<p>
			Po zaimportowaniu danych podajemy polecenie:
		</p>
			<div class="command">
				<code>
curl -s "http://localhost:9200/test/_search?size=1&pretty=1" | jq .hits.hits[].\"_source\"
				</code>
			</div>
			Wówczas otrzymano:
			<div class="code">
				<pre>
					<code>
{
  "objectid": 2005,
  "pcd2": "AB1  7FS",
  "pcds": "AB1 7FS",
  "dointr": "199205",
  "doterm": "199606",
  "oseast100m": "3912",
  "osnrth100m": "08033",
  "oscty": "S99999999",
  "odslaua": "S92",
  "oslaua": "S12000033",
  "osward": "S13002486",
  "usertype": "0",
  "osgrdind": "1",
  "ctry": "S92000003",
  "oshlthau": "SN9",
  "gor": "S99999999",
  "oldha": "SN9",
  "nhscr": "S92",
  "ccg": "012",
  "psed": "99ZZ0099",
  "cened": "ZZ0099",
  "edind": "9",
  "ward98": "00QA39",
  "oa01": "S00001586",
  "nhsrg": "S92",
  "hro": "S00",
  "lsoa01": "S01000039",
  "ur01ind": "1",
  "msoa01": "S02000008",
  "cannet": "Z99",
  "scn": "Z99",
  "oshaprev": "SN9",
  "oldpct": "X98",
  "oldhro": "S00",
  "pcon": "S14000002",
  "canreg": "Z9999",
  "pct": "012",
  "oseast1m": "391250",
  "osnrth1m": "0803360",
  "oa11": "S00090643",
  "lsoa11": "S01006526",
  "msoa11": "S02001239",
  "location": [
    -2.14614501355345,
    57.12107567680422
  ]
}
					</code>
				</pre>
			</div>
		</p>
		<h3>Mapki</h3>
			Pierwsze 1000 danych zobrazowanych, uzykanych przy pomocy polecenia:
			<div class="command">
				<code>
curl -s "http://localhost:9200/test/test/_search?size=1000&pretty=1"  | jq .hits.hits[].\"_source\" | jq --slurp . | jq {type:\"FeatureCollection\",features:.} > map1.geojson
				</code>
			</div>	
			<div class="text-center">
				<script src="https://embed.github.com/view/geojson/romety2/nosql/master/data/map1.geojson"></script>
			</div>
		</p>
		<h2>PostgreSQL</h2>
		<h3>Import danych</h3>
		<p>
			Pobieramy ze <a href="https://github.com/lukasmartinelli/pgfutter/releases/tag/v1.1" target="_blank">strony</a> pgfutter,
			oraz zmieniamy nazwę pobranego pliku na <i>pgfutter.exe</i>.
			</br>
			Następnie importujemy dane do postreSQL'a (plik z danymi oraz pgfutter muszą znajdować się w tym samym katalogu), polecenie:
			<div class="command">
				<code>
pgfutter --pass "[hasło]" --table "test" csv NHS_Postcode_Directory_Latest_Centroids.csv
				</code>
			</div>
			</br>
			Import danych średnio zużywał zasoby komputera.
			</br></br>
			<div class="text-center">
				<img src="../images/screen7.PNG" height="400em" width="500em">
			</div>
			<div class="description-image">Procesor podczas importu danych do postreSQL</div>
			</br></br>
			<div class="text-center">
				<img src="../images/screen8.PNG" height="400em" width="500em">
			</div>
			<div class="description-image">Pamięć podczas importu danych do postreSQL</div>
			</br></br>
			<div class="text-center">
				<img src="../images/screen9.PNG" height="400em" width="500em">
			</div>
			<div class="description-image">Dysk podczas importu danych do postreSQL</div>
			</br></br>
			Wykonanie trwało ok. 2 minut, 35 sekund.
			</br>
			Ostatecznie pojawił się komunikat: "2593752 rows imported into import.test"
			<div class="text-center">
				<img src="../images/screen13.PNG" height="30em" width="1200em">
			</div>
			Czyli dane zostały zaimportowane to tabeli test w schemacie import, czyli import.test.	
		</p>
		<p>
			Następnie aby uruchomić serwer, przemieszczamy się do pliku binarnego posgreSQL'a, polecenie w konsoli <i>cmd</i>:
			<div class="command">
				<code>
cd [ścieżka gdzie jest zainstalowany postgreSQL]\PostgreSQL\9.6\bin
				</code>
			</div>
			Następnie logujemy się jako domyślnie utworzony użytkownik <i>postgres</i> polecenie:
			<div class="command">
				<code>
psql -U postgres
				</code>
			</div>
			oraz podajemy hasło które ustawiliśmy przy instalacji postgreSQL'a (jeśli instalator nie wymagał podania domyślne hasło to postgrespass).
			</br></br>
			Następnie aby wyświetlić przykładową daną wydajemy polecenie.
			<div class="command">
				<code>
select * from import.test limit 1;
				</code>
			</div>
		</p>
	</div>
	</br>
	<div class = "return">
		<a href="../index.html">powrót</a>
	</div>
</body>

			<!--
			Następnie tworzymy tymczasową tabelę, polecenie:	
			<div class="command">
				<code>
create table public.test(
	x float,
	y float,
	objectid integer primary key,
	pcd2 varchar,
	pcds varchar,
	dointr integer,
	doterm integer,
	oseast100m integer,
	osnrth100m integer,
	oscty varchar,
	odslaua varchar,
	oslaua varchar,
	osward varchar,
	usertype integer,
	osgrdind integer,
	ctry varchar,
	oshlthau varchar,
	gor varchar,
	oldha varchar,
	nhscr varchar,
	ccg varchar,
	psed varchar,
	cened varchar,
	edind integer,
	ward98 varchar,
	oa01 varchar,
	nhsrg varchar,
	hro varchar,
	lsoa01 varchar,
	ur01ind integer,
	msoa01 varchar,
	cannet varchar,
	scn varchar,
	oshaprev varchar,
	oldpct varchar,
	oldhro varchar,
	pcon varchar,
	canreg varchar,
	pct varchar,
	oseast1m integer,
	osnrth1m integer,
	oa11 varchar,
	lsoa11 varchar,
	msoa11 varchar
);
				</code>
			</div>-->		